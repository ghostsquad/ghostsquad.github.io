<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#494f5c">
	<meta name="msapplication-TileColor" content="#494f5c">
<meta itemprop="name" content="Kubernetes on the Cheap - Part 2">
<meta itemprop="description" content="If you haven&rsquo;t read part 1 yet, that&rsquo;s a good place to start.
In the last post, we were left with a kubernetes cluster, and a test deployment that would break once every 24 hours, because of the preemptible instances we are using. So the highest priority right now is to fix that.
The next step is going to require you to own a domain. I recommend namecheap. You can get a .">


<meta itemprop="datePublished" content="2019-11-18T09:47:28-08:00" />
<meta itemprop="dateModified" content="2019-11-20T22:54:28-08:00" />
<meta itemprop="wordCount" content="501">



<meta itemprop="keywords" content="untagged," />
<meta property="og:title" content="Kubernetes on the Cheap - Part 2" />
<meta property="og:description" content="If you haven&rsquo;t read part 1 yet, that&rsquo;s a good place to start.
In the last post, we were left with a kubernetes cluster, and a test deployment that would break once every 24 hours, because of the preemptible instances we are using. So the highest priority right now is to fix that.
The next step is going to require you to own a domain. I recommend namecheap. You can get a ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ghostsquad.me/posts/kubernetes-on-the-cheap-part-2/" />
<meta property="article:published_time" content="2019-11-18T09:47:28-08:00" />
<meta property="article:modified_time" content="2019-11-20T22:54:28-08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kubernetes on the Cheap - Part 2"/>
<meta name="twitter:description" content="If you haven&rsquo;t read part 1 yet, that&rsquo;s a good place to start.
In the last post, we were left with a kubernetes cluster, and a test deployment that would break once every 24 hours, because of the preemptible instances we are using. So the highest priority right now is to fix that.
The next step is going to require you to own a domain. I recommend namecheap. You can get a ."/>

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>Kubernetes on the Cheap - Part 2</title>
	<link rel="stylesheet" href="https://ghostsquad.me/css/style.min.adb4e738c83b4cc0eea8000ca83f72188a2ac1fd188a1e6f7cea8a7fa75cd7b1.css" integrity="sha256-rbTnOMg7TMDuqAAMqD9yGIoqwf0Yih5vfOqKf6dc17E=" crossorigin="anonymous">
<script defer src="/fontawesome/brands.min.js"></script>
<script defer src="/fontawesome/regular.min.js"></script>
<script defer src="/fontawesome/fontawesome.min.js"></script>

</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp faster">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://ghostsquad.me">ghostsquad blog</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					
				<a href="https://ghostsquad.me/posts/">Posts</a>
				<a href="https://ghostsquad.me/about/">About</a>

				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<span class="hdr-social hide-in-mobile"><a href="https://twitter.com/WestonMcNamee" target="_blank" rel="noopener me" title="Twitter"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a><a href="https://github.com/ghostsquad" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></span><button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://ghostsquad.me/posts/">Posts</a></li>
			<li><a href="https://ghostsquad.me/about/">About</a></li>
		</ul>
	</div>


<main class="site-main section-inner animated fadeIn faster">
	<article class="thin">
		<header class="post-header">
			<h1>Kubernetes on the Cheap - Part 2</h1>
			<div class="post-meta"><span>
					<span><span class="far fa-clock"></span>&nbsp;Nov 18, 2019</span>
					<span>&nbsp;&nbsp;•&nbsp;&nbsp;</span>
					<span><span
							class="far fa-edit"></span>&nbsp;Nov 20, 2019</span></span>
				<span>&nbsp;&nbsp;•&nbsp;&nbsp;</span>
				<span><span class="far fa-hourglass"></span>&nbsp;3 min</span>
			</div>
		</header>
		<div class="content">
			

<p>If you haven&rsquo;t read <a href="/posts/kubernetes-on-the-cheap-part-1/">part 1</a> yet, that&rsquo;s a good place to start.</p>

<p>In the last post, we were left with a kubernetes cluster, and a test deployment that would break once every 24 hours, because of the preemptible instances we are using. So the highest priority right now is to fix that.</p>

<p>The next step is going to require you to own a domain. I recommend <a href="https://namecheap.com">namecheap</a>. You can get a <code>.com</code> for $8.88/yr for the first year, then $10.98/yr after that.</p>

<h2 id="table-of-contents">Table of Contents<a href="#table-of-contents" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>

<ul>
<li><a href="#table-of-contents">Table of Contents</a></li>
<li><a href="#create-a-dns-zone">Create a DNS Zone</a></li>
<li><a href="#deploy-external-dns-controller">Deploy External DNS Controller</a></li>
<li><a href="#edit-the-hello-app-to-include-the-domain-and-updated-ttl">Edit the hello app to include the domain, and updated ttl</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>

<p>To make your life easier, I&rsquo;ve variablized the commands in this post, so that you can simply set the variables, then copy/paste the commands without much trouble.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">export</span> <span class="nv">PROJECT_NAME</span><span class="o">=</span><span class="s2">&#34;kubernetes-on-the-cheap&#34;</span>
<span class="nb">export</span> <span class="nv">CLUSTER_NAME</span><span class="o">=</span><span class="s2">&#34;hobby-1&#34;</span>
<span class="nb">export</span> <span class="nv">DOMAIN</span><span class="o">=</span><span class="s2">&#34;foo.com&#34;</span></code></pre></div>
<h2 id="create-a-dns-zone">Create a DNS Zone<a href="#create-a-dns-zone" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">gcloud beta dns <span class="se">\
</span><span class="se"></span>  managed-zones create <span class="s2">&#34;</span><span class="si">${</span><span class="nv">DOMAIN</span><span class="si">}</span><span class="s2">&#34;</span> <span class="se">\
</span><span class="se"></span>  --description<span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">DOMAIN</span><span class="si">}</span><span class="s2">&#34;</span> <span class="se">\
</span><span class="se"></span>  --dns-name<span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">DOMAIN</span><span class="si">}</span><span class="s2">.&#34;</span></code></pre></div>
<p>Once the DNS zone is created, you need to update your domain registrar with the google name servers.</p>

<p>When viewing the zone, you should see an <code>NS</code> record with values like <code>ns-cloud-&lt;??&gt;.googledomains.com</code>.</p>

<p><img src="https://cloud.google.com/dns/images/zone-records.png" alt="google cloud zone records" /></p>

<p>If you chose to use namecheap, here&rsquo;s <a href="https://www.namecheap.com/support/knowledgebase/article.aspx/767/10/how-to-change-dns-for-a-domain">how to update DNS on namecheap.com</a>.</p>

<h2 id="deploy-external-dns-controller">Deploy External DNS Controller<a href="#deploy-external-dns-controller" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>

<p>Some of these steps came from <a href="https://knative.dev/docs/serving/using-external-dns-on-gcp/">knative</a></p>

<ol>
<li><p>Create a new service account for Cloud DNS admin role.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">export</span> <span class="nv">CLOUD_DNS_SA</span><span class="o">=</span>cloud-dns-admin

gcloud --project <span class="nv">$PROJECT_NAME</span> iam service-accounts <span class="se">\
</span><span class="se"></span>    create <span class="nv">$CLOUD_DNS_SA</span> <span class="se">\
</span><span class="se"></span>    --display-name <span class="s2">&#34;Service Account to support ACME DNS-01 challenge.&#34;</span></code></pre></div></li>

<li><p>Bind the role <code>dns.admin</code> to the newly created service account.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Fully-qualified service account name also has project-id information.</span>
<span class="nb">export</span> <span class="nv">CLOUD_DNS_SA_FQ</span><span class="o">=</span><span class="nv">$CLOUD_DNS_SA</span>@<span class="nv">$PROJECT_NAME</span>.iam.gserviceaccount.com

gcloud projects add-iam-policy-binding <span class="nv">$PROJECT_NAME</span> <span class="se">\
</span><span class="se"></span>    --member serviceAccount:<span class="nv">$CLOUD_DNS_SA_FQ</span> <span class="se">\
</span><span class="se"></span>    --role roles/dns.admin</code></pre></div></li>

<li><p>Download the secret key file for your service account.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">gcloud iam service-accounts keys create ~/credentials.json <span class="se">\
</span><span class="se"></span>  --iam-account<span class="o">=</span><span class="nv">$CLOUD_DNS_SA_FQ</span></code></pre></div></li>

<li><p>Upload the service account credential to your cluster. This command uses the secret name <code>cloud-dns-key</code>, but you can choose a different name.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">export</span> <span class="nv">CLOUD_DNS_SECRET_NAME</span><span class="o">=</span><span class="s2">&#34;cloud-dns-key&#34;</span>

kubectl create secret generic <span class="s2">&#34;</span><span class="si">${</span><span class="nv">CLOUD_DNS_SECRET_NAME</span><span class="si">}</span><span class="s2">&#34;</span> <span class="se">\
</span><span class="se"></span>  --from-file<span class="o">=</span>credentials.json<span class="o">=</span><span class="nv">$HOME</span>/credentials.json</code></pre></div></li>

<li><p>Deploy external dns.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">curl https://ghostsquad.me/files/kubernetes-on-the-cheap-part-2/external-dns.yaml -o external-dns.yaml
sed -i <span class="s2">&#34;s/__PROJECT_NAME__/</span><span class="si">${</span><span class="nv">PROJECT_NAME</span><span class="si">}</span><span class="s2">/g&#34;</span> external-dns.yaml
sed -i <span class="s2">&#34;s/__CLUSTER_NAME__/</span><span class="si">${</span><span class="nv">CLUSTER_NAME</span><span class="si">}</span><span class="s2">/g&#34;</span> external-dns.yaml
sed -i <span class="s2">&#34;s/__CLOUD_DNS_SECRET_NAME__/</span><span class="si">${</span><span class="nv">CLOUD_DNS_SECRET_NAME</span><span class="si">}</span><span class="s2">/g&#34;</span> external-dns.yaml
kubectl apply -f external-dns.yaml</code></pre></div></li>
</ol>

<h2 id="edit-the-hello-app-to-include-the-domain-and-updated-ttl">Edit the hello app to include the domain, and updated ttl<a href="#edit-the-hello-app-to-include-the-domain-and-updated-ttl" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">curl https://ghostsquad.me/files/kubernetes-on-the-cheap-part-2/hello.yaml -o hello-part-2.yaml
sed -i <span class="s2">&#34;s/__DOMAIN__/</span><span class="si">${</span><span class="nv">DOMAIN</span><span class="si">}</span><span class="s2">/g&#34;</span> hello-part-2.yaml
kubectl apply -f hello-part-2.yaml</code></pre></div>
<h2 id="conclusion">Conclusion<a href="#conclusion" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>

<p>We deployed external DNS so that it can keep the cluster updated with an IP address for your domain name. I even watched it go to work by scaling up to 2 nodes, then scaling back down.</p>

<p>It doesn&rsquo;t appear though that externalDNS is adding multiple A records (for each IP) when you have 2 nodes. This deserves some more research.</p>

<ul class="task-list">
<li><label><input type="checkbox" checked disabled class="task-list-item"> Setting up a domain that points to the cluster, so that we don&rsquo;t have to update the ingress</label></li>
<li><label><input type="checkbox" checked disabled class="task-list-item"> Setting up <a href="https://github.com/kubernetes-sigs/external-dns">external-dns</a> to automatically update our domain with the list of IPs of hosts (when the get preempted)</label></li>
<li><label><input type="checkbox" disabled class="task-list-item"> Setup <a href="k8s-node-termination-handler">node-termination-handler</a> to further improve shutdowns</label></li>
<li><label><input type="checkbox" disabled class="task-list-item"> Setup <a href="https://spotinst.com/pricing/">SpotInst</a> in order to handle rolling instances on a regular basis in a controlled way, and scaling the cluster temporarily while doing so.</label></li>
</ul>

<p>Stay tuned for Part 3!</p>

		</div>
		<hr class="post-end">
		<footer class="post-info">
			<p>
				<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
					stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
					class="feather feather-tag meta-icon">
					<path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
					<line x1="7" y1="7" x2="7" y2="7"></line>
				</svg><span class="tag"><a href="https://ghostsquad.me/tags/untagged">untagged</a></span>
			</p>
			<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
					stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
					class="feather feather-file-text">
					<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
					<polyline points="14 2 14 8 20 8"></polyline>
					<line x1="16" y1="13" x2="8" y2="13"></line>
					<line x1="16" y1="17" x2="8" y2="17"></line>
					<polyline points="10 9 9 9 8 9"></polyline>
				</svg>501 Words</p>
			<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
					stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
					class="feather feather-calendar">
					<rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
					<line x1="16" y1="2" x2="16" y2="6"></line>
					<line x1="8" y1="2" x2="8" y2="6"></line>
					<line x1="3" y1="10" x2="21" y2="10"></line>
				</svg>2019-11-18 09:47 -0800</p>
		</footer>
	</article>
	<div class="post-nav thin">
		<a class="prev-post" href="https://ghostsquad.me/posts/kubernetes-on-the-cheap-part-1/">
			<span class="post-nav-label">Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24"
					height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
					stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right">
					<line x1="5" y1="12" x2="19" y2="12"></line>
					<polyline points="12 5 19 12 12 19"></polyline>
				</svg></span><br><span>Kubernetes on the Cheap - Part 1</span>
		</a>
	</div>
	<div id="comments" class="thin"><script src="https://utteranc.es/client.js" repo="ghostsquad/ghostsquad.github.io" issue-term="pathname"
    label="blog-comment" theme="github-dark-orange" crossorigin="anonymous" async>
    </script></div>
</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2019 <a href="https://ghostsquad.me">Wes McNamee</a> &#183; <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a> &#183; <a href="https://ghostsquad.me/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		</p>
	</footer>



	<script src="https://ghostsquad.me/js/bundle.min.4a9a0ac3d2217822c7865b4161e6c2a71de1d70492264337755427898dd718f6.js" integrity="sha256-SpoKw9IheCLHhltBYebCpx3h1wSSJkM3dVQniY3XGPY=" crossorigin="anonymous"></script>
	
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-146422848-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


</body>

</html>
